## Test we can generate a compact section header table.

## Test normal section header table.
# RUN: yaml2obj %s --docnum=1 -DCOMPACT=false -o %t1.n
# RUN: llvm-readelf -hS %t1.n | FileCheck %s --check-prefixes=CHECK1-NORMAL,CHECK

## Test compact section header table.
# RUN: yaml2obj %s --docnum=1 -o %t1
# RUN: llvm-readelf -hS %t1 | FileCheck %s --check-prefixes=CHECK1-COMPACT,CHECK
# RUN: yaml2obj %s --docnum=1 -DENDIAN=MSB -o %t1
# RUN: llvm-readelf -hS %t1 | FileCheck %s --check-prefixes=CHECK1-COMPACT,CHECK

# CHECK1-NORMAL:       Size of section headers:           64 (bytes)
# CHECK1-COMPACT:      Size of section headers:           0 (bytes)

# CHECK:       Number of section headers:         8
# CHECK:       Section header string table index: 7

# CHECK:       Section Headers:
# CHECK:       Name              Type            Address          Off    Size   ES Flg Lk Inf Al
# CHECK:                         NULL            0000000000000000 000000 000000 00      0   0  {{[0-9]+}}
# CHECK:       .foo              PROGBITS        0000000000000000 000040 000000 00 WAE  0 131 9223372036854775808
# CHECK-NEXT:  .bar              PROGBITS        0000000000004001 000040 000000 00      0   0  65536
# CHECK-NEXT:  .another.1        PROGBITS        0000000000000000 000040 000000 00      1   0  1
# CHECK-NEXT:  .another.2        NOBITS          0000000000000000 000040 000000 00      2   0  1
# CHECK-NEXT:  .symtab           SYMTAB          0000000000000000 000040 000030 18      6   2  8
# CHECK-NEXT:  .strtab           STRTAB          0000000000000000 000070 000005 00      0   0  1
# CHECK-NEXT:  .shstrtab         STRTAB          0000000000000000 000075 00003b 00      0   0  1

--- !ELF
FileHeader:
  Class: ELFCLASS64
  Data:  ELFDATA2[[ENDIAN=LSB]]
  Type:  ET_REL
Sections:
  - Name: .foo
    Type: SHT_PROGBITS
    Info: 131
    ShAddrAlign: 0x8000000000000000
    ShFlags: 0x80000003
  - Name: .bar
    Type: SHT_PROGBITS
    Address: 0x4001
    ShAddrAlign: 0x10000
  - Name: .another.1
    Link: .foo
    Type: SHT_PROGBITS
    AddressAlign: 1
  - Name: .another.2
    Link: .bar
    Type: SHT_NOBITS
    AddressAlign: 1
  - Type: SectionHeaderTable
    Compact: [[COMPACT=true]]
Symbols:
  - Name:    foo
    Section: .foo

# RUN: yaml2obj %s --docnum=2 -o %t2
# RUN: llvm-readelf -hS %t2 | FileCheck %s --check-prefix=CHECK2

# CHECK2:      Size of section headers:           0 (bytes)
# CHECK2:      Number of section headers:         4
# CHECK2:      Section header string table index: 2
# CHECK2:      Section Headers:
# CHECK2:      Name              Type            Address          Off    Size   ES Flg Lk Inf Al
# CHECK2:                        NULL            0000000000000000 000000 000000 00      0   0  1
# CHECK2-NEXT: .strtab           STRTAB          0000000000000000 000040 000001 00      0   0  1
# CHECK2-NEXT: .shstrtab         STRTAB          0000000000000000 000041 000018 00      0   0  1
# CHECK2-NEXT: .foo              PROGBITS        0000000000000000 000040 000000 00      0   0  1

--- !ELF
FileHeader:
  Class: ELFCLASS64
  Data:  ELFDATA2LSB
  Type:  ET_REL
Sections:
  - Name: .foo
    Type: SHT_PROGBITS
  - Type: SectionHeaderTable
    Compact: true
    Sections:
      - Name: .strtab
      - Name: .shstrtab
      - Name: .foo

# RUN: not yaml2obj %s --docnum=3 -o /dev/null 2>&1 | FileCheck %s --check-prefix=ERR3

# ERR3: error: compact SectionHeaderTable must be the last entry

--- !ELF
FileHeader:
  Class: ELFCLASS64
  Data:  ELFDATA2LSB
  Type:  ET_REL
Sections:
  - Type: SectionHeaderTable
    Compact: true
    Sections:
      - Name: .strtab
      - Name: .shstrtab
      - Name: .foo
  - Name: .foo
    Type: SHT_PROGBITS

# RUN: yaml2obj %s --docnum=4 -o %t4
# RUN: llvm-readelf -hS %t4 | FileCheck %s --check-prefix=NO-HEADERS

# NO-HEADERS: Start of section headers:          0  (bytes into file)
# NO-HEADERS: Size of section headers:           0  (bytes)
# NO-HEADERS: Number of section headers:         0
# NO-HEADERS: Section header string table index: 0
# NO-HEADERS: There are no sections in this file.

--- !ELF
FileHeader:
  Class: ELFCLASS64
  Data:  ELFDATA2LSB
  Type:  ET_REL
Sections:
  - Type: SectionHeaderTable
    NoHeaders: true
    Compact: true
